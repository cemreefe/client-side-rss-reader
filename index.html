<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple RSS Reader</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rss-parser/dist/rss-parser.min.js"></script>
  <link rel="icon" type="image/png" href="https://emoji.dutl.uk/png/64x64/ðŸ“¶.png">
  <style>
    #app {
      font-family: 'Helvetica', 'Arial', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }
    .feed-item {
      margin-bottom: 20px;
    }
    .description {
      margin-top: 10px;
      border: 1px solid #aaa;
      padding: 10px;
      max-height: 80vh;
      overflow-y: scroll;
      padding-left: 2em;
      padding-right: 2em;
    }
    .description p {
      line-height: 1.4em;
    }
    .description img {
      max-width: 100%;
    }
    .meta {
      font-size: 0.9em;
      color: #555;
    }
    #form {
      margin-bottom:1em;
    }
    a {
      color: royalblue;
    }
    blockquote {
      border-left: 0.2em solid #88888888;
      padding-left: 0.5em;
      margin-left: 1em;
      font-style: italic;
      font-family: auto;
    }
    .post-title {
      text-decoration: unset;
    }
    table, th, td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 0.5em;
      width: -webkit-fill-available;
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5BQYC3C8BL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-5BQYC3C8BL');
  </script>
</head>
<body>
  <div id="app">
    <h1>Simple RSS Reader</h1>

    <small>a <a href="https://www.dutl.uk/">dutl.uk</a> app. see my source code <a href="https://github.com/cemreefe/client-side-rss-reader">here</a></small><br><br>

    <div id="form">
      <textarea v-model="rssInput" placeholder="Enter RSS feeds separated by a comma"></textarea>
      <button @click="fetchFeeds">Fetch Feeds</button>
      <button id="bookmarkMeButton">Bookmark Me</button>
    </div>

    <div v-if="loading">Loading...</div>
    <div v-if="error">{{ error }}</div>
    
    <div v-for="(item, index) in sortedFeeds" :key="index" class="feed-item">
      <div class="meta">{{ formatDate(item.pubDate) }} | {{ item.feedTitle }}</div>
      <a  href="#" @click.prevent="showDescription(item)" class="post-title">{{ item.title }}</a>
      <div v-if="item.showDescription" class="description">
        <div v-html="item.content"></div>
        <a :href="item.link" target="_blank">Read on {{ item.feedTitle }}</a>
        <button @click="closeDescription(item)">Close</button>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        rssInput: '',
        feeds: [],
        loading: false,
        error: null,
      },
      computed: {
        sortedFeeds() {
          return this.feeds.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
        },
      },
      methods: {
        async fetchFeeds() {
          this.loading = true;
          this.error = null;
          this.feeds = [];
          const parser = new RSSParser();
          const urls = this.rssInput.split(',').map(url => url.trim());

          // Update the URL with query parameters
          const queryParams = { feeds: urls };
          const queryString = new URLSearchParams(queryParams).toString();
          history.replaceState(null, null, `?${queryString}`);

          try {
            const feedPromises = urls.map(async (url) => {
              try {
                const response = await axios.get(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                const feed = await parser.parseString(response.data);
                this.feeds = this.feeds.concat(feed.items.map(item => ({
                  title: item.title,
                  link: item.link,
                  pubDate: item.pubDate,
                  content: item.content,
                  feedTitle: feed.title,
                  showDescription: false,
                })));
              } catch (err) {
                console.error(`Failed to fetch feed from ${url}`, err);
              }
            });
            await Promise.all(feedPromises);
          } catch (err) {
            this.error = 'Failed to fetch some feeds. Please check the console for details.';
          } finally {
            this.loading = false;
          }
        },
        showDescription(item) {
          this.feeds = this.feeds.map(feedItem => ({
            ...feedItem,
            showDescription: feedItem === item ? !feedItem.showDescription : feedItem.showDescription,
          }));
        },
        closeDescription(item) {
          item.showDescription = false;
        },
        formatDate(dateString) {
          const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
          return new Date(dateString).toLocaleDateString(undefined, options);
        },
        loadFeedsFromQuery() {
          const urlParams = new URLSearchParams(window.location.search);
          const feeds = urlParams.get('feeds');
          if (feeds) {
            this.rssInput = feeds.split(',').join(', ');
            this.fetchFeeds();
          }
        }
      },
      mounted() {
        this.loadFeedsFromQuery();
      }
    });

    document.getElementById('bookmarkMeButton').addEventListener('click', function(e) {
      e.preventDefault();
      var bookmarkURL = window.location.href;
      var bookmarkTitle = document.title;

      if ('addToHomescreen' in window && window.addToHomescreen.isCompatible) {
        // Mobile browsers
        addToHomescreen({ autostart: false, startDelay: 0 }).show(true);
      } else if (window.sidebar && window.sidebar.addPanel) {
        // Firefox version < 23
        window.sidebar.addPanel(bookmarkTitle, bookmarkURL, '');
      } else if ((window.sidebar && /Firefox/i.test(navigator.userAgent)) || (window.opera && window.print)) {
        // Firefox version >= 23 and Opera Hotlist
        this.setAttribute('href', bookmarkURL);
        this.setAttribute('title', bookmarkTitle);
        this.setAttribute('rel', 'sidebar');
      } else if (window.external && ('AddFavorite' in window.external)) {
        // IE Favorite
        window.external.AddFavorite(bookmarkURL, bookmarkTitle);
      } else {
        // Other browsers (mainly WebKit - Chrome/Safari)
        alert('Please press ' + (/Mac/i.test(navigator.userAgent) ? 'CMD' : 'Ctrl') + ' + D to bookmark this page.');
      }
    });
  </script>
</body>
</html>
